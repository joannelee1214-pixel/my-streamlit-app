import streamlit as st
import requests
from openai import OpenAI

# ===========================
# í˜ì´ì§€ ì„¤ì •
# ===========================
st.set_page_config(page_title="ğŸ¬ ë‚˜ì™€ ì–´ìš¸ë¦¬ëŠ” ì˜í™”ëŠ”?", page_icon="ğŸ¬")

# ===========================
# ì‚¬ì´ë“œë°”: API Keys
# ===========================
st.sidebar.title("ğŸ”‘ API ì„¤ì •")
tmdb_api_key = st.sidebar.text_input("TMDB API Key", type="password")
openai_api_key = st.sidebar.text_input("OpenAI API Key", type="password")

# OpenAI í´ë¼ì´ì–¸íŠ¸
client = None
if openai_api_key:
    client = OpenAI(api_key=openai_api_key)

# ===========================
# ì„¸ì…˜ ìƒíƒœ
# ===========================
if "answers" not in st.session_state:
    st.session_state.answers = {}

if "show_result" not in st.session_state:
    st.session_state.show_result = False

# ===========================
# ì œëª©
# ===========================
st.title("ğŸ¬ ë‚˜ì™€ ì–´ìš¸ë¦¬ëŠ” ì˜í™”ëŠ”?")
st.write("ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ + ì˜í™” ë°ì´í„° + AI ì¶”ì²œìœ¼ë¡œ")
st.write("**ë‹¹ì‹ ì´ ì§„ì§œ ì¢‹ì•„í•  ë‹¨ í•˜ë‚˜ì˜ ì˜í™”**ë¥¼ ì°¾ì•„ë“œë ¤ìš” ğŸ˜Š")

st.divider()

# ===========================
# ì§ˆë¬¸ & ì¥ë¥´
# ===========================
genres = ["ë¡œë§¨ìŠ¤/ë“œë¼ë§ˆ", "ì•¡ì…˜/ì–´ë“œë²¤ì²˜", "SF/íŒíƒ€ì§€", "ì½”ë¯¸ë””"]

questions = {
    "Q1": ("ì£¼ë§ì— ê°‘ìê¸° í•˜ë£¨ê°€ ë¹„ì—ˆë‹¤! ë„ˆì˜ ì„ íƒì€?", [
        "ì¹´í˜ì— ì•‰ì•„ ìŒì•… ë“¤ìœ¼ë©´ì„œ ì¼ê¸° ì“°ê±°ë‚˜ ì˜í™” í•œ í¸ ëª°ì•„ë³´ê¸° â˜•",
        "ì¦‰í¥ìœ¼ë¡œ ì—¬í–‰ ê°€ê±°ë‚˜ ìƒˆë¡œìš´ ì•¡í‹°ë¹„í‹° ë„ì „ ğŸš—",
        "ì§‘ì—ì„œ ì„¸ê³„ê´€ íƒ„íƒ„í•œ ì˜í™” ì •ì£¼í–‰, ìƒìƒë ¥ í’€ê°€ë™ âœ¨",
        "ì¹œêµ¬ë“¤ì´ë‘ ë§Œë‚˜ì„œ ì›ƒë‹¤ê°€ í•˜ë£¨ ìˆœì‚­ ğŸ¤£"
    ]),
    "Q2": ("ì˜í™” ë³¼ ë•Œ ê°€ì¥ ì¤‘ìš”í•œ ê±´ ë­ì•¼?", [
        "ê°ì •ì„ ê³¼ ì—¬ìš´, ë³´ê³  ë‚˜ì„œ í•œì°¸ ìƒê°ë‚˜ë©´ ìµœê³  ğŸ’­",
        "ì†ë„ê° ìˆëŠ” ì „ê°œì™€ ì†ì— ë•€ ë‚˜ëŠ” ì¥ë©´ ğŸ”¥",
        "â€œì´ëŸ° ì„¤ì •ì„ ìƒê°í–ˆë‹¤ê³ ?â€ ì‹¶ì€ ì‹ ì„ í•¨ ğŸª",
        "ì•„ë¬´ ìƒê° ì—†ì´ ì›ƒì„ ìˆ˜ ìˆëŠ” í¬ì¸íŠ¸ ğŸ˜‚"
    ]),
    "Q3": ("ê³¼ì œ í­íƒ„ ë§ì€ ì‹œí—˜ ê¸°ê°„ ë°¤, ë„ˆì˜ ê¸°ë¶„ì€?", [
        "ê´œíˆ ì„¼ì¹˜í•´ì ¸ì„œ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¶€í„° íŠ¼ë‹¤ ğŸ§",
        "ëê¹Œì§€ ë²„í‹°ê² ë‹¤ëŠ” ì˜ì§€ë¡œ ì—ë„ˆì§€ ì¶©ì „ ğŸ’ª",
        "í˜„ì‹¤ ë„í”¼í•˜ê³  ì‹¶ì–´ì„œ ë‹¤ë¥¸ ì„¸ê³„ë¥¼ ìƒìƒí•œë‹¤ ğŸŒŒ",
        "â€œì•„ ë§í–ˆë‹¤â€ í•˜ë©´ì„œë„ ë°ˆ ì°¾ì•„ë³¸ë‹¤ ğŸ¤ª"
    ]),
    "Q4": ("ë„¤ê°€ ì˜í™” ì† ì£¼ì¸ê³µì´ë¼ë©´?", [
        "ê´€ê³„ì™€ ê°ì • ì†ì—ì„œ ì„±ì¥í•˜ëŠ” ì¸ë¬¼",
        "ìœ„ê¸°ì˜ ìˆœê°„ë§ˆë‹¤ ëª¸ë¶€í„° ì›€ì§ì´ëŠ” íˆì–´ë¡œ",
        "íŠ¹ë³„í•œ ëŠ¥ë ¥ì´ë‚˜ ìš´ëª…ì„ ê°€ì§„ ì¡´ì¬",
        "ì‚¬ê±´ì„ ë” ê¼¬ì´ê²Œ ë§Œë“œëŠ” ë¶„ìœ„ê¸° ë©”ì´ì»¤"
    ]),
    "Q5": ("ì˜í™” ì—”ë”©ì€ ì´ë¬ìœ¼ë©´ ì¢‹ê² ì–´", [
        "ì¡°ìš©í•˜ì§€ë§Œ ë§ˆìŒì— ì˜¤ë˜ ë‚¨ëŠ” ê²°ë§ ğŸŒ™",
        "ëª¨ë“  ê°ˆë“±ì´ í•´ê²°ë˜ê³  ì§œë¦¿í•œ ë§ˆë¬´ë¦¬ ğŸ’¥",
        "â€œê·¸ë˜ì„œ ê·¸ ì„¸ê³„ëŠ” ê³„ì†ë ê¹Œ?â€ ì—¬ìš´ ë‚¨ê¹€ ğŸ§©",
        "í¬ë ˆë”§ ì˜¬ë¼ê°€ë„ ì›ƒìŒì´ ë©ˆì¶”ì§€ ì•ŠìŒ ğŸ˜†"
    ])
}

# ===========================
# ì§ˆë¬¸ UI
# ===========================
for q, (text, opts) in questions.items():
    st.session_state.answers[q] = st.radio(f"{q}. {text}", opts, key=q)

st.divider()

# ===========================
# ë²„íŠ¼
# ===========================
col1, col2 = st.columns(2)
with col1:
    if st.button("ğŸ¥ ê²°ê³¼ ë³´ê¸°"):
        st.session_state.show_result = True

with col2:
    if st.button("ğŸ”„ ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•˜ê¸°"):
        st.session_state.answers = {}
        st.session_state.show_result = False
        st.experimental_rerun()

# ===========================
# ê²°ê³¼ ì²˜ë¦¬
# ===========================
if st.session_state.show_result:

    if not tmdb_api_key or not openai_api_key:
        st.warning("TMDB API Keyì™€ OpenAI API Keyë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        st.stop()

    # ---------------------------
    # ì¥ë¥´ ì ìˆ˜ ê³„ì‚°
    # ---------------------------
    scores = {g: 0 for g in genres}
    for q, ans in st.session_state.answers.items():
        idx = questions[q][1].index(ans)
        scores[genres[idx]] += 1

    result_genre = max(scores, key=scores.get)

    st.subheader("ğŸ¯ ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ ê²°ê³¼")
    st.markdown(f"## **{result_genre}**")

    # ---------------------------
    # TMDB ì¥ë¥´ ID
    # ---------------------------
    tmdb_genre_map = {
        "ë¡œë§¨ìŠ¤/ë“œë¼ë§ˆ": "18,10749",
        "ì•¡ì…˜/ì–´ë“œë²¤ì²˜": "28",
        "SF/íŒíƒ€ì§€": "878,14",
        "ì½”ë¯¸ë””": "35"
    }

    # ---------------------------
    # ì˜í™” 5ê°œ ê°€ì ¸ì˜¤ê¸°
    # ---------------------------
    discover_url = (
        f"https://api.themoviedb.org/3/discover/movie"
        f"?api_key={tmdb_api_key}"
        f"&with_genres={tmdb_genre_map[result_genre]}"
        "&language=ko-KR"
        "&sort_by=popularity.desc"
    )

    movies = requests.get(discover_url).json().get("results", [])[:5]

    # ---------------------------
    # LLMì—ê²Œ ì¤„ ìš”ì•½ ì •ë³´ ìƒì„±
    # ---------------------------
    movie_summaries = []
    for m in movies:
        movie_summaries.append(
            f"- ì œëª©: {m['title']}\n"
            f"  í‰ì : {m['vote_average']}\n"
            f"  ì¤„ê±°ë¦¬: {m.get('overview', '')[:150]}"
        )

    prompt = f"""
ì‚¬ìš©ìëŠ” ëŒ€í•™ìƒì´ê³ , ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì˜í™” ì·¨í–¥ì€ '{result_genre}'ì…ë‹ˆë‹¤.

ì•„ë˜ ì˜í™” í›„ë³´ ì¤‘ì—ì„œ
ì´ ì‚¬ìš©ìê°€ **ê°€ì¥ ì¢‹ì•„í•  ê°€ëŠ¥ì„±ì´ ë†’ì€ ë‹¨ í•˜ë‚˜ì˜ ì˜í™”**ë¥¼ ê³¨ë¼ì£¼ì„¸ìš”.

ì¡°ê±´:
- í•˜ë‚˜ë§Œ ì„ íƒ
- ì™œ ì´ ì˜í™”ë¥¼ ì¶”ì²œí•˜ëŠ”ì§€ ì´ìœ ë¥¼ 2~3ë¬¸ì¥ìœ¼ë¡œ ì„¤ëª…
- ë„ˆë¬´ ë”±ë”±í•˜ì§€ ì•Šê³  ì¹œêµ¬ì—ê²Œ ì¶”ì²œí•˜ë“¯ ë§í•´ì¤˜

ì˜í™” ëª©ë¡:
{chr(10).join(movie_summaries)}
"""

    # ---------------------------
    # OpenAI API í˜¸ì¶œ
    # ---------------------------
    with st.spinner("ğŸ¤– AIê°€ ë‹¹ì‹ ì—ê²Œ ë”± ë§ëŠ” ì˜í™”ë¥¼ ê³ ë¥´ê³  ìˆì–´ìš”..."):
        response = client.chat.completions.create(
            model="gpt-4.1-mini",
            messages=[
                {"role": "system", "content": "ë„ˆëŠ” ì˜í™” ì¶”ì²œì„ ì˜í•˜ëŠ” ì¹œì ˆí•œ AIì•¼."},
                {"role": "user", "content": prompt}
            ]
        )

    ai_recommendation = response.choices[0].message.content

    st.divider()
    st.subheader("ğŸ¤– AIì˜ ìµœì¢… ì¶”ì²œ")
    st.write(ai_recommendation)
